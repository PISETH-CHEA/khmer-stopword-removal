-- database_setup.sql
-- Create database and tables for Khmer NLP System

-- Create database
CREATE DATABASE khmer_nlp_db
    WITH 
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'en_US.UTF-8'
    LC_CTYPE = 'en_US.UTF-8'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1;

-- Connect to the database
\c khmer_nlp_db;

-- Enable UUID extension if needed
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create text_analysis table
CREATE TABLE IF NOT EXISTS text_analysis (
    id SERIAL PRIMARY KEY,
    original_text TEXT NOT NULL,
    filtered_tokens JSONB,
    removed_tokens JSONB,
    frequency_stats JSONB,
    linguistic_stats JSONB,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    text_length INTEGER,
    stopwords_removed INTEGER,
    reduction_percentage FLOAT,
    
    -- Indexes for better performance
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes
CREATE INDEX idx_text_analysis_timestamp ON text_analysis(timestamp DESC);
CREATE INDEX idx_text_analysis_length ON text_analysis(text_length);
CREATE INDEX idx_text_analysis_reduction ON text_analysis(reduction_percentage DESC);

-- Create GIN indexes for JSONB columns for faster querying
CREATE INDEX idx_text_analysis_filtered_tokens ON text_analysis USING GIN (filtered_tokens);
CREATE INDEX idx_text_analysis_frequency_stats ON text_analysis USING GIN (frequency_stats);

-- Create function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Create trigger for updated_at
CREATE TRIGGER update_text_analysis_updated_at
    BEFORE UPDATE ON text_analysis
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Create view for daily statistics
CREATE OR REPLACE VIEW daily_stats AS
SELECT 
    DATE(timestamp) as analysis_date,
    COUNT(*) as total_analyses,
    AVG(text_length) as avg_text_length,
    AVG(stopwords_removed) as avg_stopwords_removed,
    AVG(reduction_percentage) as avg_reduction_percentage,
    SUM(text_length) as total_characters_processed
FROM text_analysis
GROUP BY DATE(timestamp)
ORDER BY analysis_date DESC;

-- Create view for top words analysis
CREATE OR REPLACE VIEW top_words AS
WITH word_counts AS (
    SELECT 
        key as word,
        SUM(value::INTEGER) as total_count
    FROM text_analysis,
    LATERAL jsonb_each_text(frequency_stats)
    GROUP BY key
)
SELECT 
    word,
    total_count,
    RANK() OVER (ORDER BY total_count DESC) as rank
FROM word_counts
ORDER BY total_count DESC
LIMIT 100;

-- Create user for application (optional)
-- CREATE USER khmer_nlp_user WITH PASSWORD 'secure_password_here';
-- GRANT CONNECT ON DATABASE khmer_nlp_db TO khmer_nlp_user;
-- GRANT USAGE ON SCHEMA public TO khmer_nlp_user;
-- GRANT SELECT, INSERT, UPDATE ON text_analysis TO khmer_nlp_user;
-- GRANT SELECT ON daily_stats TO khmer_nlp_user;
-- GRANT SELECT ON top_words TO khmer_nlp_user;
-- GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO khmer_nlp_user;

-- Insert sample data (optional)
INSERT INTO text_analysis (
    original_text,
    filtered_tokens,
    removed_tokens,
    frequency_stats,
    linguistic_stats,
    text_length,
    stopwords_removed,
    reduction_percentage
) VALUES (
    'កម្ពុជាជាប្រទេសដ៏ស្អាតមួយនៅក្នុងអាស៊ីអាគ្នេយ៍',
    '["កម្ពុជា", "ប្រទេស", "ស្អាត", "មួយ", "ក្នុង", "អាស៊ីអាគ្នេយ៍"]'::jsonb,
    '["ជា", "ដ៏", "នៅ"]'::jsonb,
    '{"កម្ពុជា": 1, "ប្រទេស": 1, "ស្អាត": 1, "មួយ": 1, "ក្នុង": 1, "អាស៊ីអាគ្នេយ៍": 1}'::jsonb,
    '{"total_tokens": 9, "unique_tokens": 8}'::jsonb,
    45,
    3,
    33.33
);

-- Create comments
COMMENT ON TABLE text_analysis IS 'Stores text analysis results from Khmer stopword removal system';
COMMENT ON COLUMN text_analysis.filtered_tokens IS 'JSON array of filtered tokens';
COMMENT ON COLUMN text_analysis.frequency_stats IS 'JSON object with token frequencies';
COMMENT ON COLUMN text_analysis.reduction_percentage IS 'Percentage reduction after stopword removal';

-- Create backup function
CREATE OR REPLACE FUNCTION backup_old_analyses()
RETURNS void AS $$
BEGIN
    -- Create backup table if not exists
    CREATE TABLE IF NOT EXISTS text_analysis_backup AS 
    SELECT * FROM text_analysis WHERE 1=0;
    
    -- Insert old records (older than 1 year)
    INSERT INTO text_analysis_backup
    SELECT * FROM text_analysis 
    WHERE timestamp < NOW() - INTERVAL '1 year';
    
    -- Delete old records
    DELETE FROM text_analysis 
    WHERE timestamp < NOW() - INTERVAL '1 year';
END;
$$ LANGUAGE plpgsql;